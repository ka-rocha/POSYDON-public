<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Large-Scale Population Synthesis on HPC Facilities üöÄ &mdash; POSYDON v2.0.0-dev documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=8ace0c28" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f4b7fd8b"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Stellar Transient Populations üîç" href="bbh_analysis.html" />
    <link rel="prev" title="Your First Binary Simulations with POSYDON üå†" href="10_binaries_pop_syn.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/posydon_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v2.0.0-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction-acknowledgements/intro.html">Introduction, Objectives, and Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction-acknowledgements/collaborative-team.html">Collaborative Team</a></li>
<li class="toctree-l1"><a class="reference external" href="https://posydon.org/papers.html">Publications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/installation-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/verification.html">Verification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user-guides/user-roadmap.html">Roadmap to Becoming an Expert POSYDON User</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guides/web-application.html">Web Application: POSYDON Interactive Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guides/database-query-system.html">Database and Query System</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials and Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="binary-pop-syn.html">Binary-Star Population Synthesis with POSYDON</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="10_binaries_pop_syn.html">Your First Binary Simulations with POSYDON üå†</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_binaries_pop_syn.html#Creating-and-running-a-binary-population">Creating and running a binary population</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_binaries_pop_syn.html#Inspecting-the-population:-Population-class">Inspecting the population: Population class</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Large-Scale Population Synthesis on HPC Facilities üöÄ</a></li>
<li class="toctree-l2"><a class="reference internal" href="bbh_analysis.html">Stellar Transient Populations üîç</a></li>
<li class="toctree-l2"><a class="reference internal" href="bbh_analysis.html#Transient-population">Transient population</a></li>
<li class="toctree-l2"><a class="reference internal" href="lgrb_pop_syn.html">Computing Long-Duration Gamma-Ray Bursts from Double Compact Object Populations üåå</a></li>
<li class="toctree-l2"><a class="reference internal" href="one_met_pop_syn.html">Explore the assumption of star-formation history and DCO compute rates at one single metallicity üìñ</a></li>
<li class="toctree-l2"><a class="reference internal" href="one_met_pop_syn.html#Single-metallicity-population">Single metallicity population</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug_pop.html">Debugging POSYDON Binary Population Synthesis üêû</a></li>
<li class="toctree-l2"><a class="reference internal" href="VHD.html">Van den Heuvel Diagrams</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../generating-datasets/generating-datasets.html">Crafting the Core Datasets for POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MESA-grids/running-grids.html">Architecting MESA Simulation Grids with POSYDON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">In-Depth Components Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../components-overview/mesa-grids.html">MESA Grids API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../components-overview/processing-pipeline.html">Processing Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../components-overview/machine-learning-components.html">Machine Learning Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../components-overview/stellar-binary-simulation.html">Stellar &amp; Binary-star Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/posydon.html">posydon package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/bin.html">executables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Troubleshooting and FAQs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting-faqs/installation-issues.html">Installation Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting-faqs/code-questions.html">Code Usage Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to POSYDON</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/how-to-contribute.html">How To Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/code-style-guidelines.html">Code Style Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reporting-issues.html">Reporting issues</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release Notes and Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/version-history.html">Version History of POSYDON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/major-updates.html">Major Updates</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contact and Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contact-support/contact-information.html">Contact Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">POSYDON</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="binary-pop-syn.html">Binary-Star Population Synthesis with POSYDON</a></li>
      <li class="breadcrumb-item active">Large-Scale Population Synthesis on HPC Facilities üöÄ</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials-examples/population-synthesis/pop_syn.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Large-Scale-Population-Synthesis-on-HPC-Facilities-üöÄ">
<h1>Large-Scale Population Synthesis on HPC Facilities üöÄ<a class="headerlink" href="#Large-Scale-Population-Synthesis-on-HPC-Facilities-üöÄ" title="Link to this heading">ÔÉÅ</a></h1>
<p><strong>Tutorial goal</strong></p>
<p>This tutorial will cover how to setup and run a large, multi-metallicity population run on a HPC with slurm.</p>
<p>We will dive deeper into the <code class="docutils literal notranslate"><span class="pre">population_params.ini</span></code> file and the <code class="docutils literal notranslate"><span class="pre">Population</span></code> class for multi-metallicity populations.</p>
<p>If you haven‚Äôt done so yet, export the path POSYDON environment variables. For example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> PATH_TO_POSYDON=/Users/simone/Google Drive/github/POSYDON-public/
<span class="o">%</span><span class="k">env</span> PATH_TO_POSYDON_DATA=/Volumes/T7/
</pre></div>
</div>
</div>
<section id="Creating-the-Initialization-File-for-multi-metallicity-runs">
<h2>Creating the Initialization File for multi-metallicity runs<a class="headerlink" href="#Creating-the-Initialization-File-for-multi-metallicity-runs" title="Link to this heading">ÔÉÅ</a></h2>
<p>Let‚Äôs copy the default population synthesis ini file to your working directory. Make sure you‚Äôre on a cluster to be able to run and submit the jobs.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">posydon.config</span> <span class="kn">import</span> <span class="n">PATH_TO_POSYDON</span>

<span class="n">path_to_params</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_POSYDON</span><span class="p">,</span> <span class="s2">&quot;posydon/popsyn/population_params_default.ini&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">path_to_params</span><span class="p">,</span> <span class="s1">&#39;./population_params.ini&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Open the <code class="docutils literal notranslate"><span class="pre">population_params.ini</span></code> file and do the following edits to run a large model at 8 differet metallicities:</p>
<ul class="simple">
<li><p>set <code class="docutils literal notranslate"><span class="pre">metallicity</span> <span class="pre">=</span> <span class="pre">[2.,</span> <span class="pre">1.,</span> <span class="pre">0.45,</span> <span class="pre">0.2,</span> <span class="pre">0.1,</span> <span class="pre">0.01,</span> <span class="pre">0.001,</span> <span class="pre">0.0001]</span></code></p></li>
<li><p>set <code class="docutils literal notranslate"><span class="pre">number_of_binaries</span> <span class="pre">=</span> <span class="pre">100</span></code></p></li>
</ul>
<p>You might also want to make sure the <code class="docutils literal notranslate"><span class="pre">dump_rate</span></code> is set to 10 binaries. <code class="docutils literal notranslate"><span class="pre">dump_rate</span> <span class="pre">=</span> <span class="pre">10</span></code></p>
</section>
<section id="Setting-up-the-Population-Synthesis-Model">
<h2>Setting-up the Population Synthesis Model<a class="headerlink" href="#Setting-up-the-Population-Synthesis-Model" title="Link to this heading">ÔÉÅ</a></h2>
<p>POSYDON provides <code class="docutils literal notranslate"><span class="pre">setup-popsyn</span></code> that you can use to setup a (multi-)metallicity population run on a HPC facility.</p>
<p>This will split each metallicity into a separate slurm job-array and a dependent job which will automatically merge the output of the separate jobs.</p>
<p>Below are two examples, but you might require to adjust the inputs for your email, cluster and available partitions.</p>
<div class="alert alert-block alert-warning"><p>Older POSYDON installations</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">setup-popsyn</span></code> command is not available, you might have to install POSYDON. 1. Go to the directory: <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">$PATH_TO_POSYDON</span></code> 2. Uninstall using pip <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">uninstall</span> <span class="pre">posydon</span></code> 3. Reinstall: if you‚Äôre using the development version: <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">.</span></code></p>
<p>See the <a href="#id1"><span class="problematic" id="id2">`Installation instructions &lt;&gt;`__</span></a> if any issues occur.</p>
<div><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for yggdrasil</span>
<span class="n">posydon</span><span class="o">-</span><span class="n">setup</span><span class="o">-</span><span class="n">popsyn</span> <span class="n">population_params</span><span class="o">.</span><span class="n">ini</span> <span class="o">--</span><span class="n">job_array</span><span class="o">=</span><span class="mi">10</span> <span class="o">--</span><span class="n">walltime</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">00</span> <span class="o">--</span><span class="n">partition</span><span class="o">=</span><span class="n">debug</span><span class="o">-</span><span class="n">cpu</span> <span class="o">--</span><span class="n">email</span><span class="o">=</span><span class="nb">max</span><span class="o">.</span><span class="n">briel</span><span class="nd">@unige</span><span class="o">.</span><span class="n">ch</span> <span class="o">--</span><span class="n">account</span><span class="o">=</span><span class="n">fragkos</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for quest cluster</span>
<span class="n">posydon</span><span class="o">-</span><span class="n">setup</span><span class="o">-</span><span class="n">popsyn</span> <span class="n">population_params</span><span class="o">.</span><span class="n">ini</span> <span class="o">--</span><span class="n">job</span><span class="o">-</span><span class="n">array</span><span class="o">=</span><span class="mi">10</span> <span class="o">--</span><span class="n">walltime</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">setup-popsyn</span> <span class="pre">--help</span></code> should provide a complete list of possible input parameters.</p>
<section id="walltime-and-job_array-number-fine-tuning">
<h3>walltime and job_array number fine-tuning<a class="headerlink" href="#walltime-and-job_array-number-fine-tuning" title="Link to this heading">ÔÉÅ</a></h3>
<p>The above examples will setup the population run with an array of 10 jobs for each metallicity. As such, each job will run 10 binaries of the 100 binaries per metallicity.</p>
<p>Fine-tuning the <code class="docutils literal notranslate"><span class="pre">dump_rate</span></code> compared to the number of binaries each job runs can be helpful. However, the larger the <code class="docutils literal notranslate"><span class="pre">dump_rate</span></code> the higher the memory footprint of each job. As a default, 4Gb of RAM is requested per job.</p>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">walltime</span></code> and <code class="docutils literal notranslate"><span class="pre">job_array</span></code> can be fine-tuned. A single binary takes about 1-2 seconds to run. Depending on the number of binaries each job does, you might want to raise or lower the walltime for optimal perfomance.</p>
<p>For example, with 100.000 binaries split over 100 jobs (per metallicity), means that every job runs 1.000 binaries. <code class="docutils literal notranslate"><span class="pre">dump_rate=1000</span></code> is a good amount of binaries to keep in memory, when you‚Äôre doing an initial-final run (see here for more details on different run types). This will take around 33 minutes per job. So a walltime of <code class="docutils literal notranslate"><span class="pre">00:45:00</span></code> is reasonable.</p>
<p>Instead of setting a <code class="docutils literal notranslate"><span class="pre">dump_rate</span></code>, it‚Äôs also possible to set a <code class="docutils literal notranslate"><span class="pre">ram_per_cpu</span></code>. The code will try to stay below 90% of this limit, but this is not always guaranteed due to additional python overhead.</p>
<p>After you‚Äôve ran the above setup, you should now have several files in your work directory.</p>
<p>You can submit all job arrays and merged jobs using <code class="docutils literal notranslate"><span class="pre">slurm_submit.sh</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">slurm_submit</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div>
<p>If one of your runs fails, you can manually submit them again after fixing the issue. The <code class="docutils literal notranslate"><span class="pre">*_logs</span></code> folder will contain the logs of each job in the job_array.</p>
</section>
</section>
<section id="Populations-inspection">
<h2>Populations inspection<a class="headerlink" href="#Populations-inspection" title="Link to this heading">ÔÉÅ</a></h2>
<p>Once the runs and the mergers have finished. You should have 8 files named <code class="docutils literal notranslate"><span class="pre">MET_Zsun_population.h5</span></code>, where <code class="docutils literal notranslate"><span class="pre">MET</span></code> are the metallicities.</p>
<p>We will inspect two to check the number of binaries in the population.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">posydon.popsyn.synthetic_population</span> <span class="kn">import</span> <span class="n">Population</span>

<span class="n">file1</span> <span class="o">=</span> <span class="s1">&#39;1e-01_Zsun_population.h5&#39;</span>
<span class="n">file2</span> <span class="o">=</span> <span class="s1">&#39;1e-02_Zsun_population.h5&#39;</span>

<span class="n">pop1</span> <span class="o">=</span> <span class="n">Population</span><span class="p">(</span><span class="n">file1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pop1</span><span class="o">.</span><span class="n">mass_per_metallicity</span><span class="p">)</span>

<span class="n">pop2</span> <span class="o">=</span> <span class="n">Population</span><span class="p">(</span><span class="n">file2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pop2</span><span class="o">.</span><span class="n">mass_per_metallicity</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In the next tutorial, we will look into selecting specific events and combining the different metallicity runs into a single population!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="10_binaries_pop_syn.html" class="btn btn-neutral float-left" title="Your First Binary Simulations with POSYDON üå†" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="bbh_analysis.html" class="btn btn-neutral float-right" title="Stellar Transient Populations üîç" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tassos Fragos.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>